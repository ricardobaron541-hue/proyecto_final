<!DOCTYPE html> <!-- Indica que el documento sigue el est√°ndar HTML5 -->
<html lang="es"> <!-- Idioma principal del documento -->
<head>
    <meta charset="UTF-8"> <!-- Permite uso de caracteres con tildes y √± -->
    <title>Carrito</title> <!-- T√≠tulo en la pesta√±a del navegador -->

    <!-- Importa el archivo CSS desde la carpeta /static -->
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body>

    <!-- ENCABEZADO DE LA P√ÅGINA -->
    <header class="header">

        <!-- LOGO DEL NEGOCIO -->
        <div class="logo">
            <img src="{{ url_for('static', filename='logo.png') }}" alt="Logo">
        </div>

        <!-- MEN√ö DE NAVEGACI√ìN -->
        <nav class="nav">
            <a href="/" class="nav-btn">INICIO</a>
            <a href="/producto" class="nav-btn active">PRODUCTO</a>
            <a href="/nosotros" class="nav-btn">NOSOTROS</a>
            <a href="/contacto" class="nav-btn">CONTACTO</a>
        </nav>
    </header>

<!-- T√çTULO PRINCIPAL -->
<h1 class="titulo-carrito">Carrito de Compras</h1>

<!-- TABLA QUE MUESTRA LOS PRODUCTOS DEL CARRITO -->
<table class="tabla-carrito">
    <thead>
        <tr>
            <th>Nombre Producto</th>
            <th>Cantidad</th>
            <th>Precio</th>
            <th>Foto</th>
            <th>Acciones</th>
        </tr>
    </thead>

    <tbody>
        {% for p in carrito %} <!-- Recorre cada producto del carrito -->
        <tr data-titulo="{{ p.titulo|e }}"> <!-- Guarda el t√≠tulo como atributo del <tr> -->

            <!-- NOMBRE DEL PRODUCTO -->
            <td class="td-titulo">{{ p.titulo }}</td>

            <!-- CONTROL DE CANTIDAD -->
            <td class="td-cantidad">

                <!-- Contenedor que alinea flechas y n√∫mero -->
                <div class="cantidad-wrap" style="display:flex; align-items:center; gap:12px; justify-content:center;">

                    <!-- Controles de sumar/restar (en columna ‚Üí ‚¨Ü ‚¨á) -->
                    <div class="cantidad-controles" style="display:flex; flex-direction:column; gap:6px;">
                        <button class="btn-cantidad" data-accion="sumar" type="button" aria-label="incrementar">‚¨Ü</button>
                        <button class="btn-cantidad" data-accion="restar" type="button" aria-label="disminuir">‚¨á</button>
                    </div>

                    <!-- Muestra el n√∫mero actual de piezas -->
                    <span class="cantidad-num" data-cantidad="{{ p.cantidad }}">{{ p.cantidad }}</span>
                </div>
            </td>

            <!-- PRECIO DEL PRODUCTO -->
            <td class="td-precio">{{ p.precio }} $</td>

            <!-- IMAGEN DEL PRODUCTO -->
            <td>
                <img src="{{ p.imagen }}" class="img-carrito">
            </td>

            <!-- BOT√ìN PARA ELIMINAR EL √çTEM -->
            <td>
                <a href="/eliminar_item/{{ p.titulo }}" class="btn-eliminar">üóëÔ∏è</a>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<!-- BOT√ìN PARA AVANZAR AL FORMULARIO (solo si hay productos en el carrito) -->
{% if carrito|length > 0 %}
<button id="btn-siguiente" class="btn-siguiente">Siguiente</button>
{% endif %}

<!-- FORMULARIO DE DATOS DEL CLIENTE (se oculta inicialmente) -->
<div id="formulario-compra" style="display:none;" class="formulario-compra">
    <h2>Datos del Comprador</h2>

    <form action="/guardar_compra" method="POST">

        <!-- CAMPOS DEL CLIENTE -->
        <label>Nombre:</label>
        <input type="text" name="nombre" required>

        <label>Correo:</label>
        <input type="email" name="correo" required>

        <label>Telefono:</label>
        <input type="number" name="telefono" required>

        <label>Direcci√≥n:</label>
        <input type="text" name="direccion" required>

        <!-- SE MUESTRA DETALLE GENERADO AUTOM√ÅTICAMENTE -->
        <label>Detalle de la Compra:</label>
        <textarea id="detalle-compra" name="detalle" readonly style="height:130px;"></textarea>

        <!-- BOT√ìN PARA FINALIZAR COMPRA -->
        <button type="submit" class="btn-finalizar">Finalizar compra</button>

    </form>

</div>

<!-- SCRIPT 1: Actualiza cantidades en tiempo real usando FETCH -->
<script>
// funci√≥n que env√≠a actualizaci√≥n al backend (sumar/restar)
async function enviarActualizar(titulo, accion, row) {

    try {
        const body = new URLSearchParams();
        body.append('titulo', titulo);
        body.append('accion', accion);

        const resp = await fetch('/actualizar_cantidad', {
            method: 'POST',
            body: body,
            headers: { 'X-Requested-With': 'XMLHttpRequest' } // marca como petici√≥n AJAX
        });

        if (!resp.ok) throw new Error('Respuesta no OK');

        const data = await resp.json();

        if (data.ok) {

            // Si la cantidad lleg√≥ a 0, refresca la p√°gina
            if (data.removed) {
                window.location.reload();
                return;
            }

            // Actualiza la cantidad en pantalla
            const span = row.querySelector('.cantidad-num');
            if (span) {
                span.textContent = data.cantidad;
                span.dataset.cantidad = data.cantidad;
            }
        }

    } catch (err) {
        console.error('Error actualizar cantidad:', err);
    }
}
</script>

<!-- SCRIPT 2: Manejo de botones de cantidad y edici√≥n directa -->
<script>
document.addEventListener('DOMContentLoaded', function() {

    // Botones de flechas (sumar/restar)
    document.querySelectorAll('.btn-cantidad').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            const accion = this.dataset.accion;
            const row = this.closest('tr');
            const titulo = row?.dataset?.titulo;
            if (!titulo) return;
            enviarActualizar(titulo, accion, row);
        });
    });

    // Permite editar cantidad manualmente tocando el n√∫mero
    document.querySelectorAll('.cantidad-num').forEach(span => {
        span.addEventListener('click', function() {

            const current = parseInt(this.dataset.cantidad || this.textContent || '1', 10);

            // Crear input editable
            const input = document.createElement('input');
            input.type = 'number';
            input.min = 1;
            input.value = current;
            input.style.width = '60px';
            input.className = 'input-cantidad-directa';

            const spanParent = this.parentElement;
            this.style.display = 'none';
            spanParent.appendChild(input);
            input.focus();

            input.addEventListener('blur', async () => {
                const newVal = parseInt(input.value || '0', 10);
                input.remove();
                this.style.display = '';

                const row = this.closest('tr');
                const titulo = row.dataset.titulo;

                if (newVal <= 0) {
                    // elimina el producto si vuelve 0
                    await enviarActualizar(titulo, 'restar');
                    window.location.reload();
                    return;
                }

                const diff = newVal - current;
                if (diff === 0) return;

                const accion = diff > 0 ? 'sumar' : 'restar';
                const veces = Math.abs(diff);

                // Aplica cambios uno por uno
                for (let i = 0; i < veces; i++) {
                    await enviarActualizar(titulo, accion, row);
                }
            });

            // Enter para confirmar
            input.addEventListener('keydown', (ev) => {
                if (ev.key === 'Enter') {
                    ev.preventDefault();
                    input.blur();
                }
            });
        });
    });

});
</script>

<!-- SCRIPT 3: Bot√≥n "Siguiente" ‚Üí Oculta carrito y muestra formulario -->
<script>
document.getElementById("btn-siguiente")?.addEventListener("click", function() {

    // Oculta elementos del carrito
    document.getElementById("btn-siguiente").style.display = "none";
    document.querySelector(".tabla-carrito").style.display = "none";
    document.querySelector(".titulo-carrito").style.display = "none";

    // Muestra formulario
    document.getElementById("formulario-compra").style.display = "block";

    // Calcula total y detalle
    let total = 0;
    document.querySelectorAll("tbody tr").forEach(fila => {
        let cantidad = parseInt(fila.querySelector(".cantidad-num").innerText);
        let precio = parseFloat(fila.children[2].innerText.replace("$","").trim());
        total += cantidad * precio;
    });

    let detalle = "";
    document.querySelectorAll("tbody tr").forEach(fila => {
        let nombre = fila.querySelector(".td-titulo").innerText;
        let cantidad = parseInt(fila.querySelector(".cantidad-num").innerText);
        let precio = parseFloat(fila.children[2].innerText.replace("$","").trim());
        let subtotal = cantidad * precio;
        detalle += `${nombre}  x${cantidad}  ‚Üí  ${subtotal} $\n`;
    });

    detalle += `\nTOTAL: ${total} $`;

    document.getElementById("detalle-compra").value = detalle;

});
</script>

<!-- SCRIPT 4: Enviar compra con fetch y animaci√≥n -->
<script>
document.querySelector(".formulario-compra form")?.addEventListener("submit", async function(e){

    e.preventDefault(); // Evita recarga para permitir animaci√≥n

    const formData = new FormData(this);

    // Env√≠a compra al backend
    const resp = await fetch("/guardar_compra", {
        method: "POST",
        body: formData
    });

    if (resp.status === 200 || resp.status === 302) {

        // Muestra alerta animada
        const alerta = document.createElement("div");
        alerta.className = "alerta-compra";
        alerta.innerHTML = `
            <div class="alerta-contenido">
                <h2>¬°Gracias por tu compra!</h2>
                <p>Tu pedido ha sido registrado exitosamente.</p>
            </div>
        `;
        document.body.appendChild(alerta);

        // Limpia carrito y redirige
        setTimeout(async () => {
            await fetch("/vaciar_carrito", { method: "POST" });
            window.location.href = "/producto";
        }, 2500);
    }
});
</script>

</body>
</html>
